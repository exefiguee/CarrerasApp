<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de AdministraciÃ³n - Horse Racing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        query,
        orderBy,
        onSnapshot,
        updateDoc,
        deleteDoc,
        increment,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAGAkg8tc0AV6WhGxnZISnI0OScaqQV1P0",
        authDomain: "corseweb-914bf.firebaseapp.com",
        projectId: "corseweb-914bf",
        storageBucket: "corseweb-914bf.firebasestorage.app",
        messagingSenderId: "771172579871",
        appId: "1:771172579871:web:47a0015fa0aa4213d2332a",
        measurementId: "G-GMR6X5C05Z",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Variables globales
      let currentAdminEmail = "";

      // ========== VERIFICAR QUE SEA ADMIN ==========
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          alert("âŒ Debes iniciar sesiÃ³n");
          window.location.href = "index.html";
          return;
        }

        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          
          if (!userDoc.exists()) {
            alert("âŒ Usuario no encontrado en la base de datos");
            await signOut(auth);
            window.location.href = "index.html";
            return;
          }

          const userData = userDoc.data();
          
          if (userData.role !== "admin") {
            alert("âŒ No tienes permisos de administrador");
            await signOut(auth);
            window.location.href = "index.html";
            return;
          }

          // Usuario es admin
          currentAdminEmail = user.email;
          document.getElementById("adminEmail").textContent = user.email;
          document.getElementById("loadingScreen").classList.add("hidden");
          document.getElementById("adminPanel").classList.remove("hidden");

          // Cargar datos
          loadUsers();
          loadRechargeRequests();
          loadStats();
        } catch (error) {
          console.error("Error verificando admin:", error);
          alert("âŒ Error al verificar permisos");
          window.location.href = "index.html";
        }
      });

      // ========== CERRAR SESIÃ“N ==========
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        if (confirm("Â¿Cerrar sesiÃ³n?")) {
          await signOut(auth);
          window.location.href = "index.html";
        }
      });

      // ========== CREAR USUARIO ==========
      document.getElementById("createUserForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("newUserEmail").value;
        const password = document.getElementById("newUserPassword").value;
        const userName = document.getElementById("userName").value;
        const initialBalance = parseFloat(document.getElementById("initialBalance").value) || 0;

        const btnCreate = document.getElementById("btnCreate");
        btnCreate.disabled = true;
        btnCreate.textContent = "Creando...";

        try {
          // Crear usuario en Authentication
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const newUser = userCredential.user;

          // Crear documento en Firestore (colecciÃ³n 'users')
          await setDoc(doc(db, "users", newUser.uid), {
            email: email,
            name: userName,
            balance: initialBalance,
            role: "user",
            totalBet: 0,
            totalWon: 0,
            totalLost: 0,
            createdAt: new Date(),
            createdBy: auth.currentUser.uid,
          });

          // Mostrar credenciales
          const credentials = `
âœ… Usuario creado exitosamente

ğŸ‘¤ Nombre: ${userName}
ğŸ“§ Email: ${email}
ğŸ”‘ ContraseÃ±a: ${password}
ğŸ’° Saldo inicial: $${initialBalance.toLocaleString('es-AR')}

ğŸ“± EnviÃ¡ estas credenciales al usuario por WhatsApp.
          `;

          alert(credentials);

          // Copiar al portapapeles
          const textToCopy = `
Horse Racing Bet ğŸ‡

Tu cuenta ha sido creada:
ğŸ“§ Email: ${email}
ğŸ”‘ ContraseÃ±a: ${password}
ğŸ’° Saldo: $${initialBalance.toLocaleString('es-AR')}

IngresÃ¡ en: https://tuapp.com
          `.trim();

          navigator.clipboard.writeText(textToCopy).then(() => {
            alert("âœ… Credenciales copiadas al portapapeles!");
          });

          // Limpiar formulario
          document.getElementById("createUserForm").reset();
        } catch (error) {
          console.error("Error al crear usuario:", error);
          
          let errorMsg = "Error al crear usuario";
          if (error.code === "auth/email-already-in-use") {
            errorMsg = "El email ya estÃ¡ registrado";
          } else if (error.code === "auth/weak-password") {
            errorMsg = "La contraseÃ±a debe tener al menos 6 caracteres";
          } else if (error.code === "auth/invalid-email") {
            errorMsg = "Email invÃ¡lido";
          }
          
          alert("âŒ " + errorMsg);
        } finally {
          btnCreate.disabled = false;
          btnCreate.textContent = "Crear Usuario";
        }
      });

      // ========== CARGAR USUARIOS ==========
      function loadUsers() {
        const q = query(collection(db, "users"), orderBy("createdAt", "desc"));

        onSnapshot(q, (snapshot) => {
          const usersList = document.getElementById("usersList");
          usersList.innerHTML = "";

          let totalUsers = 0;
          let totalBalance = 0;

          snapshot.forEach((doc) => {
            const user = doc.data();
            const userId = doc.id;

            totalUsers++;
            totalBalance += user.balance || 0;

            const userCard = `
              <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-2">
                  <div>
                    <h3 class="font-bold text-lg">${user.name || "Sin nombre"}</h3>
                    <p class="text-sm text-gray-600">${user.email}</p>
                  </div>
                  <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                    user.role === "admin"
                      ? "bg-red-100 text-red-800"
                      : "bg-blue-100 text-blue-800"
                  }">
                    ${user.role === "admin" ? "ADMIN" : "USUARIO"}
                  </span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm mt-3">
                  <div>ğŸ’° Balance: <strong>$${(user.balance || 0).toLocaleString('es-AR')}</strong></div>
                  <div>ğŸ¯ Apostado: $${(user.totalBet || 0).toLocaleString('es-AR')}</div>
                  <div>âœ… Ganado: $${(user.totalWon || 0).toLocaleString('es-AR')}</div>
                  <div>âŒ Perdido: $${(user.totalLost || 0).toLocaleString('es-AR')}</div>
                </div>
                <div class="mt-3 flex gap-2">
                  <button onclick="addBalance('${userId}', '${user.email}')" class="flex-1 bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                    ğŸ’µ Cargar Saldo
                  </button>
                  <button onclick="viewUserBets('${userId}', '${user.name || user.email}')" class="flex-1 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                    ğŸ“Š Ver Apuestas
                  </button>
                  ${
                    user.role !== "admin"
                      ? `<button onclick="deleteUser('${userId}', '${user.email}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                    ğŸ—‘ï¸
                  </button>`
                      : ""
                  }
                </div>
              </div>
            `;

            usersList.innerHTML += userCard;
          });

          // Actualizar stats
          document.getElementById("totalUsers").textContent = totalUsers;
          document.getElementById("totalBalance").textContent = `$${totalBalance.toLocaleString('es-AR')}`;
        });
      }

      // ========== CARGAR SOLICITUDES DE RECARGA ==========
      function loadRechargeRequests() {
        const q = query(
          collection(db, "rechargeRequests"),
          orderBy("createdAt", "desc")
        );

        onSnapshot(q, (snapshot) => {
          const requestsList = document.getElementById("requestsList");
          requestsList.innerHTML = "";

          if (snapshot.empty) {
            requestsList.innerHTML =
              '<p class="text-gray-500 text-center py-4">No hay solicitudes pendientes</p>';
            return;
          }

          snapshot.forEach((doc) => {
            const request = doc.data();
            const requestId = doc.id;

            if (request.status === "pending") {
              const requestCard = `
                <div class="border border-yellow-300 bg-yellow-50 rounded-lg p-4">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <p class="font-bold">${request.userEmail || "Usuario"}</p>
                      <p class="text-2xl font-bold text-green-600">$${(request.amount || 0).toLocaleString('es-AR')}</p>
                    </div>
                    <span class="px-2 py-1 bg-yellow-200 text-yellow-800 rounded text-xs font-semibold">
                      PENDIENTE
                    </span>
                  </div>
                  <div class="flex gap-2 mt-3">
                    <button onclick="approveRecharge('${requestId}')" class="flex-1 bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600">
                      âœ… Aprobar
                    </button>
                    <button onclick="rejectRecharge('${requestId}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">
                      âŒ Rechazar
                    </button>
                  </div>
                </div>
              `;

              requestsList.innerHTML += requestCard;
            }
          });
        });
      }

      // ========== CARGAR ESTADÃSTICAS ==========
      function loadStats() {
        const q = query(collection(db, "APUESTAS_GLOBAL"), orderBy("timestamps.creacion", "desc"));

        onSnapshot(q, (snapshot) => {
          let totalBets = 0;
          let pendingBets = 0;
          let totalAmount = 0;

          snapshot.forEach((doc) => {
            const bet = doc.data();
            totalBets++;
            
            if (bet.estado === "PENDIENTE") {
              pendingBets++;
            }
            
            totalAmount += bet.montos?.montoTotal || 0;
          });

          document.getElementById("totalBets").textContent = totalBets;
          document.getElementById("pendingBets").textContent = pendingBets;
          document.getElementById("totalBetAmount").textContent = `$${totalAmount.toLocaleString('es-AR')}`;
        });
      }

      // ========== FUNCIONES GLOBALES ==========
      window.addBalance = async (userId, userEmail) => {
        const amount = prompt(`ğŸ’° Â¿CuÃ¡nto saldo querÃ©s agregar a ${userEmail}?`);
        if (!amount || isNaN(amount) || Number(amount) <= 0) return;

        try {
          const userRef = doc(db, "users", userId);
          await updateDoc(userRef, {
            balance: increment(Number(amount)),
          });

          alert(`âœ… Se agregaron $${Number(amount).toLocaleString('es-AR')} al usuario`);
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Error al agregar saldo");
        }
      };

      window.deleteUser = async (userId, userEmail) => {
        if (!confirm(`Â¿EstÃ¡s seguro de eliminar a ${userEmail}?`)) return;

        try {
          await deleteDoc(doc(db, "users", userId));
          alert("âœ… Usuario eliminado");
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Error al eliminar usuario");
        }
      };

      window.viewUserBets = (userId, userName) => {
        alert(`ğŸ“Š Ver apuestas de ${userName}\n\n(Esta funciÃ³n se puede implementar con un modal)`);
      };

      window.approveRecharge = async (requestId) => {
        const paymentMethod = prompt("MÃ©todo de pago:", "Transferencia bancaria");
        if (!paymentMethod) return;

        alert("âš ï¸ Esta funciÃ³n requiere Cloud Function 'approveRecharge'");
      };

      window.rejectRecharge = async (requestId) => {
        if (!confirm("Â¿Rechazar esta solicitud?")) return;

        try {
          await updateDoc(doc(db, "rechargeRequests", requestId), {
            status: "rejected",
            rejectedAt: new Date(),
          });

          alert("âœ… Solicitud rechazada");
        } catch (error) {
          console.error("Error:", error);
          alert("âŒ Error al rechazar solicitud");
        }
      };
    </script>
  </head>
  <body class="bg-gray-100">
    <!-- Pantalla de carga -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4">ğŸ‡</div>
        <p class="text-xl">Verificando permisos...</p>
      </div>
    </div>

    <!-- Panel de admin (oculto por defecto) -->
    <div id="adminPanel" class="hidden min-h-screen">
      <!-- Header -->
      <header class="bg-red-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
          <h1 class="text-2xl font-bold">ğŸ‡ Panel de AdministraciÃ³n</h1>
          <div class="flex items-center gap-4">
            <span class="text-sm" id="adminEmail"></span>
            <button
              id="logoutBtn"
              class="bg-red-700 hover:bg-red-800 px-4 py-2 rounded">
              Cerrar SesiÃ³n
            </button>
          </div>
        </div>
      </header>

      <div class="container mx-auto p-4 max-w-7xl">
        <!-- EstadÃ­sticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-lg shadow p-4">
            <div class="text-gray-600 text-sm">Total Usuarios</div>
            <div class="text-3xl font-bold" id="totalUsers">0</div>
          </div>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="text-gray-600 text-sm">Saldo Total</div>
            <div class="text-3xl font-bold text-green-600" id="totalBalance">$0</div>
          </div>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="text-gray-600 text-sm">Total Apuestas</div>
            <div class="text-3xl font-bold" id="totalBets">0</div>
          </div>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="text-gray-600 text-sm">Apuestas Pendientes</div>
            <div class="text-3xl font-bold text-yellow-600" id="pendingBets">0</div>
          </div>
        </div>

        <!-- Crear Usuario -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h2 class="text-xl font-bold mb-4">â• Crear Nuevo Usuario</h2>
          <form id="createUserForm" class="grid md:grid-cols-2 gap-4">
            <input
              type="text"
              id="userName"
              placeholder="Nombre del usuario"
              required
              class="border rounded px-3 py-2" />
            <input
              type="email"
              id="newUserEmail"
              placeholder="Email"
              required
              class="border rounded px-3 py-2" />
            <input
              type="password"
              id="newUserPassword"
              placeholder="ContraseÃ±a (mÃ­n. 6 caracteres)"
              required
              minlength="6"
              class="border rounded px-3 py-2" />
            <input
              type="number"
              id="initialBalance"
              placeholder="Saldo inicial"
              value="0"
              min="0"
              class="border rounded px-3 py-2" />
            <button
              id="btnCreate"
              type="submit"
              class="md:col-span-2 bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700">
              Crear Usuario y Copiar Credenciales
            </button>
          </form>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Lista de Usuarios -->
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">ğŸ‘¥ Usuarios Registrados</h2>
            <div id="usersList" class="space-y-4 max-h-[600px] overflow-y-auto"></div>
          </div>

          <!-- Solicitudes de Recarga -->
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">ğŸ’° Solicitudes de Recarga</h2>
            <div id="requestsList" class="space-y-4 max-h-[600px] overflow-y-auto"></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
```

## ğŸš€ **CÃ³mo usarlo:**

1. **Accede al panel:**
```
   http://localhost:5173/admin.html