<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horse Racing Bet - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#dc2626",
              secondary: "#1e293b",
            },
          },
        },
      };
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAGAkg8tc0AV6WhGxnZISnI0OScaqQV1P0",
        authDomain: "corseweb-914bf.firebaseapp.com",
        projectId: "corseweb-914bf",
        storageBucket: "corseweb-914bf.firebasestorage.app",
        messagingSenderId: "771172579871",
        appId: "1:771172579871:web:47a0015fa0aa4213d2332a",
        measurementId: "G-GMR6X5C05Z",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ‚úÖ Verificar si ya est√° logueado
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log("‚úÖ Usuario ya logueado:", user.email);
          
          try {
            // Verificar si es admin
            const userDoc = await getDoc(doc(db, "users", user.uid));
            
            if (userDoc.exists() && userDoc.data().role === "admin") {
              console.log("üîë Redirigiendo a panel admin...");
              window.location.href = "/admin.html";
            } else {
              console.log("üë§ Redirigiendo a carreras...");
              window.location.href = "/";
            }
          } catch (error) {
            console.error("Error verificando rol:", error);
            // Si hay error, redirigir a carreras
            window.location.href = "/";
          }
        }
      });

      let email = "";
      let password = "";
      let loading = false;

      const emailInput = document.getElementById("emailInput");
      const passwordInput = document.getElementById("passwordInput");
      const errorDiv = document.getElementById("errorDiv");
      const submitBtn = document.getElementById("submitBtn");
      const btnText = document.getElementById("btnText");
      const spinner = document.getElementById("spinner");

      emailInput.addEventListener("input", (e) => {
        email = e.target.value;
      });

      passwordInput.addEventListener("input", (e) => {
        password = e.target.value;
      });

      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.classList.remove("hidden");
      }

      function clearError() {
        errorDiv.textContent = "";
        errorDiv.classList.add("hidden");
      }

      function setLoading(isLoading) {
        loading = isLoading;
        if (isLoading) {
          submitBtn.disabled = true;
          submitBtn.classList.add("bg-gray-400", "cursor-not-allowed");
          submitBtn.classList.remove("bg-primary", "hover:bg-red-600");
          spinner.classList.remove("hidden");
          btnText.textContent = "Ingresando...";
        } else {
          submitBtn.disabled = false;
          submitBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
          submitBtn.classList.add("bg-primary", "hover:bg-red-600");
          spinner.classList.add("hidden");
          btnText.textContent = "Ingresar";
        }
      }

      submitBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        clearError();

        if (!email || !password) {
          showError("Por favor completa todos los campos");
          return;
        }

        setLoading(true);

        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          
          console.log("‚úÖ Login exitoso:", user.email);
          
          // Verificar si es admin
          const userDoc = await getDoc(doc(db, "users", user.uid));
          
          if (userDoc.exists() && userDoc.data().role === "admin") {
            console.log("üîë Redirigiendo a panel admin...");
            window.location.href = "/admin.html";
          } else {
            console.log("üë§ Redirigiendo a carreras...");
            window.location.href = "/";
          }
          
        } catch (err) {
          console.error("‚ùå Error de login:", err);
          
          const errorMessage =
            err.code === "auth/user-not-found"
              ? "Usuario no encontrado. Contact√° al administrador."
              : err.code === "auth/wrong-password"
              ? "Contrase√±a incorrecta"
              : err.code === "auth/invalid-email"
              ? "Email inv√°lido"
              : err.code === "auth/invalid-credential"
              ? "Credenciales inv√°lidas"
              : "Error al iniciar sesi√≥n. Intent√° nuevamente.";

          showError(errorMessage);
        } finally {
          setLoading(false);
        }
      });
      
      passwordInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !loading) {
          submitBtn.click();
        }
      });
    </script>
  </head>
  <body>
    <div
      class="min-h-screen bg-gradient-to-br from-secondary to-gray-800 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-8">
        <!-- Logo/Header -->
        <div class="text-center mb-8">
          <div class="text-6xl mb-4">üèá</div>
          <h1 class="text-3xl font-bold text-secondary mb-2">
            Horse Racing Bet
          </h1>
          <p class="text-gray-600">Apuestas en carreras de Argentina</p>
        </div>

        <!-- T√≠tulo -->
        <h2 class="text-2xl font-bold text-center mb-6 text-secondary">
          Iniciar Sesi√≥n
        </h2>

        <!-- Form -->
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Email
            </label>
            <input
              type="email"
              id="emailInput"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="tu@email.com" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Contrase√±a
            </label>
            <input
              type="password"
              id="passwordInput"
              required
              minlength="6"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>

          <!-- Error message -->
          <div
            id="errorDiv"
            class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm hidden"></div>

          <button
            id="submitBtn"
            class="w-full font-bold py-3 rounded-lg transition-colors bg-primary hover:bg-red-600 text-white">
            <span class="flex items-center justify-center">
              <svg
                id="spinner"
                class="animate-spin h-5 w-5 mr-2 hidden"
                viewBox="0 0 24 24">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                  fill="none" />
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
              </svg>
              <span id="btnText">Ingresar</span>
            </span>
          </button>
        </div>

        <!-- Info -->
        <div class="mt-6 text-center text-sm text-gray-500">
          <p>üîí Si no ten√©s cuenta, contact√° al administrador</p>
          <p class="mt-2">‚ö†Ô∏è Solo mayores de 18 a√±os</p>
        </div>
      </div>
    </div>
  </body>
</html>